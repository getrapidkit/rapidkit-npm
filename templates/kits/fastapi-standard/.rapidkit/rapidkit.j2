#!/usr/bin/env bash
# Local RapidKit project launcher (npm demo template)
# This script provides local project commands for demo projects.

set -euo pipefail
ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"

show_help() {
  cat << 'EOF'
üìö RapidKit FastAPI Project Commands

Usage: rapidkit <command> [options]

Commands:
  init         üì¶ Initialize project (poetry install)
  dev          üöÄ Start development server with hot reload
  start        ‚ö° Start production server
  test         üß™ Run tests
  lint         üîß Lint code
  format       ‚ú® Format code
  help         üìö Show this help

Examples:
  rapidkit init      # Install dependencies
  rapidkit dev       # Start dev server

üí° Note: Commands are run through Poetry.
EOF
}

# Handle help
case "${1:-}" in
  help|--help|-h|"")
    show_help
    exit 0
    ;;
esac

# Detect project type
if [ -f "$ROOT_DIR/pyproject.toml" ]; then
  PKG_TYPE="python"
elif [ -f "$ROOT_DIR/package.json" ]; then
  PKG_TYPE="node"
else
  PKG_TYPE="unknown"
fi

VENV_PY="${ROOT_DIR}/.venv/bin/python"
VENV_POETRY="${ROOT_DIR}/.venv/bin/poetry"

case "$PKG_TYPE" in
  python)
    # prefer project-local poetry
    if [ -x "$VENV_POETRY" ]; then
      if [ "${1:-}" = "init" ]; then
        exec "$VENV_POETRY" "install"
      else
        exec "$VENV_POETRY" "run" "$@"
      fi
    fi

    # then prefer poetry on PATH
    if command -v poetry >/dev/null 2>&1; then
      if [ "${1:-}" = "init" ]; then
        exec poetry "install"
      else
        exec poetry "run" "$@"
      fi
    fi

    # If venv python exists, try installing poetry into it
    if [ -x "$VENV_PY" ]; then
      echo "‚ö†Ô∏è  Poetry not found. Installing poetry into project .venv..."
      "$VENV_PY" -m pip install --upgrade pip >/dev/null 2>&1 || true
      "$VENV_PY" -m pip install poetry >/dev/null 2>&1 || true
      if [ -x "$VENV_POETRY" ]; then
        if [ "${1:-}" = "init" ]; then
          exec "$VENV_POETRY" "install"
        else
          exec "$VENV_POETRY" "run" "$@"
        fi
      else
        echo "‚ùå Failed to locate poetry after installation."
        exit 1
      fi
    fi

    echo "‚ùå Poetry is not available and no project .venv exists."
    echo "üí° Run: 'poetry install' to bootstrap the project, or install poetry: 'pip install poetry'"
    exit 127
    ;;

  *)
    echo "‚ùå Could not detect project type (pyproject.toml missing)."
    echo "üí° This appears to be a demo project. Run 'poetry install' to set up."
    exit 127
    ;;
esac
