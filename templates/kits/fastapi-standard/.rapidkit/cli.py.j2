#!/usr/bin/env python3
"""RapidKit CLI wrapper (npm demo template)

This file provides local project commands for demo projects generated
via npx rapidkit --demo. It mimics the behavior of the full RapidKit
engine for dev, start, test, lint, and format commands.
"""

import subprocess
import shutil
import sys
from pathlib import Path
import socket
from typing import Any


def _print_banner(emoji: str, message: str) -> None:
    print(f"{emoji} {message}")


def _run(*cmd: Any, cwd: Path | str | None = None, env: dict | None = None) -> int:
    try:
        run_env = None
        if env is not None:
            import os as _os
            run_env = _os.environ.copy()
            run_env.update(env)

        proc = subprocess.run([str(c) for c in cmd], cwd=str(cwd) if cwd else None, env=run_env)
        return proc.returncode
    except KeyboardInterrupt:
        print("\nğŸ›‘ Command interrupted by user")
        return 130
    except Exception as exc:
        print(f"âŒ Error running command: {exc}")
        return 1


def _project_type(root: Path) -> str:
    if (root / "pyproject.toml").exists():
        return "python"
    if (root / "package.json").exists():
        return "node"
    return "unknown"


def _python_module(module: str, *module_args: str) -> int:
    return _run(sys.executable, "-m", module, *module_args)


def _python_code_targets(root: Path) -> list[str]:
    targets: list[str] = []
    for name in ("src", "tests"):
        if (root / name).exists():
            targets.append(name)
    return targets or ["src"]


def _venv_has_uvicorn(venv_path: Path) -> bool:
    if (venv_path / "bin" / "uvicorn").exists():
        return True
    for p in venv_path.rglob("site-packages/*"):
        name = p.name.lower()
        if "uvicorn" in name or "fastapi" in name:
            return True
    return False


def dev(port: int = 8000, host: str = "0.0.0.0", allow_global_runtime: bool = False) -> None:
    """Start development server with reload"""
    _print_banner("ğŸš€", "Starting development server with hot reload...")
    root = Path.cwd()
    ptype = _project_type(root)

    if ptype == "python":
        venv_dir = root / ".venv"

        if venv_dir.exists():
            if not _venv_has_uvicorn(venv_dir):
                print("âŒ Project .venv was found but uvicorn/fastapi doesn't appear installed.")
                print("ğŸ’¡ Run 'poetry install' to install dependencies.")
                sys.exit(1)
        else:
            if not allow_global_runtime:
                print("âŒ Project environment not bootstrapped (no .venv found).")
                print("")
                print("ğŸ’¡ Initialize and install dependencies with:")
                print("")
                print("  poetry install")
                print("")
                print("If you intentionally want to use the system Python, run:")
                print("")
                print("  rapidkit dev --allow-global-runtime")
                print("")
                sys.exit(1)

            if shutil.which("uvicorn") is None:
                print("âŒ No uvicorn executable found on PATH and no .venv present.")
                print("")
                print("ğŸ’¡ Install dependencies with: poetry install")
                print("")
                sys.exit(1)
            print("âš ï¸  Running with system/global Python runtime.")

        rc = _run(sys.executable, "-m", "uvicorn", "src.main:app", "--reload", "--host", host, "--port", str(port))
        if rc != 0:
            sys.exit(rc)
    else:
        print("âŒ Unknown project type. Ensure pyproject.toml exists.")
        sys.exit(1)


def init() -> None:
    """Bootstrap project: install dependencies"""
    _print_banner("ğŸš€", "Bootstrapping project (installing dependencies)")
    root = Path.cwd()
    ptype = _project_type(root)
    
    if ptype == "python":
        if shutil.which("poetry"):
            rc = _run("poetry", "install")
            if rc != 0:
                print("âŒ Failed to install dependencies via poetry.")
                sys.exit(rc)
            print("âœ… Dependencies installed successfully!")
        else:
            print("âŒ Poetry not found. Install it with: pip install poetry")
            sys.exit(1)
    else:
        print("âŒ Unknown project type. Ensure pyproject.toml exists.")
        sys.exit(1)


def start(port: int = 8000, host: str = "0.0.0.0", allow_global_runtime: bool = False) -> None:
    """Start production server"""
    _print_banner("âš¡", "Starting production server...")
    root = Path.cwd()
    ptype = _project_type(root)
    
    if ptype == "python":
        venv_dir = root / ".venv"
        if venv_dir.exists():
            if not _venv_has_uvicorn(venv_dir):
                print("âŒ Project .venv was found but uvicorn/fastapi doesn't appear installed.")
                print("ğŸ’¡ Run 'poetry install' to install dependencies.")
                sys.exit(1)
        else:
            if not allow_global_runtime:
                print("âŒ Project environment not bootstrapped (no .venv found).")
                print("ğŸ’¡ Run 'poetry install' to install dependencies.")
                sys.exit(1)

        rc = _run(sys.executable, "-m", "uvicorn", "src.main:app", "--host", host, "--port", str(port))
        if rc != 0:
            sys.exit(rc)
    else:
        print("âŒ Unknown project type.")
        sys.exit(1)


def build() -> None:
    """Build project"""
    _print_banner("ğŸ“¦", "Building project")
    rc = _python_module("build")
    if rc != 0:
        sys.exit(rc)


def test() -> None:
    """Run tests"""
    _print_banner("ğŸ§ª", "Running tests")
    rc = _python_module("pytest", "-q")
    if rc != 0:
        sys.exit(rc)


def lint() -> None:
    """Run linting"""
    _print_banner("ğŸ”§", "Running lint")
    root = Path.cwd()
    targets = _python_code_targets(root)
    rc = _python_module("ruff", "check", *targets)
    if rc == 0:
        rc = _python_module("black", "--check", *targets)
    if rc != 0:
        sys.exit(rc)


def format_code() -> None:
    """Format code"""
    _print_banner("âœ¨", "Formatting")
    root = Path.cwd()
    targets = _python_code_targets(root)
    rc = _python_module("ruff", "check", *targets, "--fix")
    if rc == 0:
        rc = _python_module("black", *targets)
    if rc != 0:
        sys.exit(rc)


def help_cmd() -> None:
    """Show help"""
    _print_banner("ğŸ“š", "Project Commands")
    print("Usage: rapidkit <command> [args...]\n")
    print("  init     ğŸ“¦ Initialize project (install deps)")
    print("  dev      ğŸš€ Start development server")
    print("  start    âš¡ Start production server")
    print("  build    ğŸ“¦ Build for production")
    print("  test     ğŸ§ª Run tests")
    print("  lint     ğŸ”§ Lint code")
    print("  format   âœ¨ Format code")
    print("  help     ğŸ“š Show help")
    print("")
    print("ğŸ’¡ Note: This is a demo project. For full RapidKit features:")
    print("   pipx install rapidkit")


def main():
    if len(sys.argv) < 2 or sys.argv[1] in ("-h", "--help", "help"):
        help_cmd()
        return

    command = sys.argv[1]
    args = sys.argv[2:]

    commands = {
        "init": init,
        "dev": dev,
        "start": start,
        "build": build,
        "test": test,
        "lint": lint,
        "format": format_code,
        "help": help_cmd,
    }

    if command not in commands:
        print(f"âŒ Unknown command: {command}")
        help_cmd()
        sys.exit(1)

    if command in ("dev", "start"):
        import argparse as _arg
        _parser = _arg.ArgumentParser(prog=f"rapidkit {command}")
        _parser.add_argument("-p", "--port", dest="port", type=int, default=8000)
        _parser.add_argument("--host", dest="host", default="0.0.0.0")
        _parser.add_argument("--allow-global-runtime", action="store_true", dest="allow_global_runtime")
        _ns, _extra = _parser.parse_known_args(args)
        commands[command](port=_ns.port, host=_ns.host, allow_global_runtime=_ns.allow_global_runtime)
    else:
        commands[command]()


if __name__ == "__main__":
    main()
