#!/usr/bin/env bash
# RapidKit CLI wrapper for NestJS projects (npm demo template)
# This script provides local commands that mirror the full RapidKit engine.

set -e

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$PROJECT_ROOT"

print_banner() {
    local emoji="$1"
    local message="$2"
    echo "$emoji $message"
}

check_node() {
    if ! command -v node &> /dev/null; then
        echo "âŒ Node.js not found. Please install Node.js first."
        exit 1
    fi
}

check_npm_or_pnpm() {
    if command -v pnpm &> /dev/null; then
        echo "pnpm"
    elif command -v npm &> /dev/null; then
        echo "npm"
    else
        echo "âŒ Neither npm nor pnpm found. Please install Node.js first."
        exit 1
    fi
}

cmd_init() {
    print_banner "ğŸ“¦" "Bootstrapping NestJS project (installing dependencies)"
    check_node
    
    local pkg_manager=$(check_npm_or_pnpm)
    
    if [ "$pkg_manager" = "pnpm" ]; then
        pnpm install
    else
        npm install
    fi
    
    echo "âœ… Dependencies installed successfully!"
}

cmd_dev() {
    local port="${1:-8000}"
    local host="${2:-0.0.0.0}"
    
    print_banner "ğŸš€" "Starting NestJS development server with hot reload..."
    check_node
    
    if [ ! -d "node_modules" ]; then
        echo "âŒ node_modules not found. Run 'rapidkit init' first."
        exit 1
    fi
    
    local pkg_manager=$(check_npm_or_pnpm)
    
    if [ "$pkg_manager" = "pnpm" ]; then
        PORT="$port" HOST="$host" pnpm run start:dev
    else
        PORT="$port" HOST="$host" npm run start:dev
    fi
}

cmd_start() {
    local port="${1:-8000}"
    local host="${2:-0.0.0.0}"
    
    print_banner "âš¡" "Starting NestJS production server..."
    check_node
    
    if [ ! -d "node_modules" ]; then
        echo "âŒ node_modules not found. Run 'rapidkit init' first."
        exit 1
    fi
    
    local pkg_manager=$(check_npm_or_pnpm)
    
    if [ "$pkg_manager" = "pnpm" ]; then
        PORT="$port" HOST="$host" pnpm run start:prod
    else
        PORT="$port" HOST="$host" npm run start:prod
    fi
}

cmd_build() {
    print_banner "ğŸ“¦" "Building NestJS project..."
    check_node
    
    local pkg_manager=$(check_npm_or_pnpm)
    
    if [ "$pkg_manager" = "pnpm" ]; then
        pnpm run build
    else
        npm run build
    fi
    
    echo "âœ… Build completed!"
}

cmd_test() {
    print_banner "ğŸ§ª" "Running tests..."
    check_node
    
    local pkg_manager=$(check_npm_or_pnpm)
    
    if [ "$pkg_manager" = "pnpm" ]; then
        pnpm run test
    else
        npm run test
    fi
}

cmd_lint() {
    print_banner "ğŸ”§" "Running ESLint..."
    check_node
    
    local pkg_manager=$(check_npm_or_pnpm)
    
    if [ "$pkg_manager" = "pnpm" ]; then
        pnpm run lint
    else
        npm run lint
    fi
}

cmd_format() {
    print_banner "âœ¨" "Formatting code with Prettier..."
    check_node
    
    local pkg_manager=$(check_npm_or_pnpm)
    
    if [ "$pkg_manager" = "pnpm" ]; then
        pnpm run format
    else
        npm run format
    fi
}

cmd_help() {
    print_banner "ğŸ“š" "RapidKit NestJS Project Commands"
    echo ""
    echo "Usage: rapidkit <command> [options]"
    echo ""
    echo "Commands:"
    echo "  init         ğŸ“¦ Initialize project (install dependencies)"
    echo "  dev          ğŸš€ Start development server with hot reload"
    echo "  start        âš¡ Start production server"
    echo "  build        ğŸ“¦ Build for production"
    echo "  test         ğŸ§ª Run tests"
    echo "  lint         ğŸ”§ Lint code"
    echo "  format       âœ¨ Format code"
    echo "  help         ğŸ“š Show this help"
    echo ""
    echo "Options for dev/start:"
    echo "  -p, --port <port>   Port number (default: 8000)"
    echo "  --host <host>       Host address (default: 0.0.0.0)"
    echo ""
    echo "ğŸ’¡ Note: This is a demo project. For full RapidKit features:"
    echo "   pipx install rapidkit"
}

# Parse command
COMMAND="${1:-help}"
shift || true

# Parse options
PORT="8000"
HOST="0.0.0.0"

while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--port)
            PORT="$2"
            shift 2
            ;;
        --host)
            HOST="$2"
            shift 2
            ;;
        -h|--help)
            cmd_help
            exit 0
            ;;
        *)
            shift
            ;;
    esac
done

case "$COMMAND" in
    init)
        cmd_init
        ;;
    dev)
        cmd_dev "$PORT" "$HOST"
        ;;
    start)
        cmd_start "$PORT" "$HOST"
        ;;
    build)
        cmd_build
        ;;
    test)
        cmd_test
        ;;
    lint)
        cmd_lint
        ;;
    format)
        cmd_format
        ;;
    help|-h|--help)
        cmd_help
        ;;
    *)
        echo "âŒ Unknown command: $COMMAND"
        echo ""
        cmd_help
        exit 1
        ;;
esac
