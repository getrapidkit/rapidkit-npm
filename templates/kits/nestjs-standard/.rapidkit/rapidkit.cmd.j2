@echo off
REM RapidKit CLI wrapper for NestJS projects (Windows)
REM This script provides local commands that mirror the full RapidKit engine.

setlocal enabledelayedexpansion

set "PROJECT_ROOT=%~dp0.."
cd /d "%PROJECT_ROOT%"

set "COMMAND=%~1"
if "%COMMAND%"=="" set "COMMAND=help"

set "PORT=8000"
set "HOST=0.0.0.0"

REM Parse remaining arguments for port/host
:parse_args
if "%~2"=="" goto :run_command
if "%~2"=="-p" (
    set "PORT=%~3"
    shift
    shift
    goto :parse_args
)
if "%~2"=="--port" (
    set "PORT=%~3"
    shift
    shift
    goto :parse_args
)
if "%~2"=="--host" (
    set "HOST=%~3"
    shift
    shift
    goto :parse_args
)
shift
goto :parse_args

:run_command
if /i "%COMMAND%"=="init" goto :cmd_init
if /i "%COMMAND%"=="dev" goto :cmd_dev
if /i "%COMMAND%"=="start" goto :cmd_start
if /i "%COMMAND%"=="build" goto :cmd_build
if /i "%COMMAND%"=="test" goto :cmd_test
if /i "%COMMAND%"=="lint" goto :cmd_lint
if /i "%COMMAND%"=="format" goto :cmd_format
if /i "%COMMAND%"=="help" goto :cmd_help
if /i "%COMMAND%"=="-h" goto :cmd_help
if /i "%COMMAND%"=="--help" goto :cmd_help
goto :cmd_unknown

:check_node
where node >nul 2>&1
if %ERRORLEVEL% NEQ 0 (
    echo âŒ Node.js not found. Please install Node.js first.
    exit /b 1
)
exit /b 0

:get_pkg_manager
where pnpm >nul 2>&1
if %ERRORLEVEL% EQU 0 (
    set "PKG_MANAGER=pnpm"
) else (
    set "PKG_MANAGER=npm"
)
exit /b 0

:cmd_init
echo ğŸ“¦ Bootstrapping NestJS project (installing dependencies)
call :check_node
if %ERRORLEVEL% NEQ 0 exit /b 1
call :get_pkg_manager
%PKG_MANAGER% install
echo âœ… Dependencies installed successfully!
goto :eof

:cmd_dev
echo ğŸš€ Starting NestJS development server with hot reload...
call :check_node
if %ERRORLEVEL% NEQ 0 exit /b 1
if not exist "node_modules" (
    echo âŒ node_modules not found. Run 'rapidkit init' first.
    exit /b 1
)
call :get_pkg_manager
set "PORT=%PORT%"
set "HOST=%HOST%"
%PKG_MANAGER% run start:dev
goto :eof

:cmd_start
echo âš¡ Starting NestJS production server...
call :check_node
if %ERRORLEVEL% NEQ 0 exit /b 1
if not exist "node_modules" (
    echo âŒ node_modules not found. Run 'rapidkit init' first.
    exit /b 1
)
call :get_pkg_manager
set "PORT=%PORT%"
set "HOST=%HOST%"
%PKG_MANAGER% run start:prod
goto :eof

:cmd_build
echo ğŸ“¦ Building NestJS project...
call :check_node
if %ERRORLEVEL% NEQ 0 exit /b 1
call :get_pkg_manager
%PKG_MANAGER% run build
echo âœ… Build completed!
goto :eof

:cmd_test
echo ğŸ§ª Running tests...
call :check_node
if %ERRORLEVEL% NEQ 0 exit /b 1
call :get_pkg_manager
%PKG_MANAGER% run test
goto :eof

:cmd_lint
echo ğŸ”§ Running ESLint...
call :check_node
if %ERRORLEVEL% NEQ 0 exit /b 1
call :get_pkg_manager
%PKG_MANAGER% run lint
goto :eof

:cmd_format
echo âœ¨ Formatting code with Prettier...
call :check_node
if %ERRORLEVEL% NEQ 0 exit /b 1
call :get_pkg_manager
%PKG_MANAGER% run format
goto :eof

:cmd_help
echo ğŸ“š RapidKit NestJS Project Commands
echo.
echo Usage: rapidkit ^<command^> [options]
echo.
echo Commands:
echo   init         ğŸ“¦ Initialize project (install dependencies)
echo   dev          ğŸš€ Start development server with hot reload
echo   start        âš¡ Start production server
echo   build        ğŸ“¦ Build for production
echo   test         ğŸ§ª Run tests
echo   lint         ğŸ”§ Lint code
echo   format       âœ¨ Format code
echo   help         ğŸ“š Show this help
echo.
echo Options for dev/start:
echo   -p, --port ^<port^>   Port number (default: 8000)
echo   --host ^<host^>       Host address (default: 0.0.0.0)
echo.
echo ğŸ’¡ Note: This is a demo project. For full RapidKit features:
echo    pipx install rapidkit
goto :eof

:cmd_unknown
echo âŒ Unknown command: %COMMAND%
echo.
goto :cmd_help
